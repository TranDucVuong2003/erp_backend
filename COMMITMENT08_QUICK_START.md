# ?? TÓM T?T: API Download File M?u Thông T? 08

## ? ?ã hoàn thành

### 1. **T?o file m?u HTML**
?? **V? trí:** `wwwroot/templates/salary-forms/Cam_Ket_Thong_Tu_08.html`

**N?i dung:**
- ? Tiêu ?? chính th?c theo format Nhà n??c
- ? 6 ?i?u kho?n cam k?t theo Thông t? 08/2019/TT-BTC
- ? Form ?i?n thông tin cá nhân (H? tên, CMND, ??a ch?, v.v.)
- ? Ph?n ký tên
- ? H??ng d?n ?i?n (?n khi in)
- ? CSS t?i ?u cho in A4

### 2. **Thêm 3 API Endpoints m?i**

#### API 1: Download file m?u HTML
```
GET /api/SalaryContracts/download-commitment08-template
```
- ? Không c?n authentication (AllowAnonymous)
- ? Tr? v? file HTML ?? nhân viên t?i v?

#### API 2: Download file m?u PDF (optional)
```
GET /api/SalaryContracts/download-commitment08-template-pdf
```
- ? Không c?n authentication
- ?? Ch? ho?t ??ng n?u b?n upload file PDF vào `wwwroot/templates/salary-forms/`

#### API 3: Ki?m tra yêu c?u Thông t? 08
```
GET /api/SalaryContracts/check-commitment08-required/{userId}
```
- ? C?n authentication (JWT Bearer Token)
- ? Tr? v? thông tin: user có c?n ?i?n không + link download

---

## ?? Cách s? d?ng

### **B??c 1: Admin t?o Salary Contract**

Khi t?o contract cho nhân viên có l??ng th?p (? 2 tri?u/tháng):

```javascript
POST /api/SalaryContracts

FormData:
- UserId: 38
- BaseSalary: 1800000
- HasCommitment08: true  ?? SET = TRUE
- ...
```

### **B??c 2: Frontend ki?m tra yêu c?u**

```javascript
const response = await fetch('/api/SalaryContracts/check-commitment08-required/38', {
  headers: { 'Authorization': `Bearer ${token}` }
});

const result = await response.json();

if (result.data.isRequired) {
  // Hi?n th? nút download
  console.log('Download URL:', result.data.downloadTemplateUrl);
}
```

**Response:**
```json
{
  "message": "Ki?m tra thành công",
  "data": {
    "userId": 38,
    "hasCommitment08": true,
    "isRequired": true,
    "baseSalary": 1800000,
    "downloadTemplateUrl": "/api/SalaryContracts/download-commitment08-template",
    "note": "Nhân viên c?n t?i v?, ?i?n và n?p l?i Cam k?t Thông t? 08"
  }
}
```

### **B??c 3: Nhân viên download file m?u**

```javascript
const handleDownload = async () => {
  const response = await fetch('/api/SalaryContracts/download-commitment08-template');
  const blob = await response.blob();
  const url = window.URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Mau_Cam_Ket_Thong_Tu_08.html';
  a.click();
  
  window.URL.revokeObjectURL(url);
};
```

### **B??c 4: Nhân viên ?i?n thông tin**

1. M? file HTML v?a t?i
2. ?i?n ??y ?? thông tin cá nhân
3. In ra 2 b?n, ký tên
4. Scan/ch?p ?nh file ?ã ký

### **B??c 5: Nhân viên upload file ?ã ?i?n**

```javascript
PUT /api/SalaryContracts/{contractId}

FormData:
- Attachment: [File ?ã ?i?n và ký]  ?? Upload file này
```

---

## ?? C?u trúc th? m?c

```
erp_backend/
??? wwwroot/
    ??? templates/
    ?   ??? salary-forms/
    ?       ??? Cam_Ket_Thong_Tu_08.html  ? File m?u (?ã có)
    ?       ??? Cam_Ket_Thong_Tu_08.pdf   ?? Optional (ch?a có)
    ?
    ??? uploads/
        ??? salary-contracts/
            ??? Nguyen_Van_A_38/
                ??? abc123-guid.pdf  ?? File nhân viên upload sau khi ?i?n
```

---

## ?? Test nhanh v?i cURL

### Test 1: Download file m?u
```bash
curl -X GET "http://localhost:5000/api/SalaryContracts/download-commitment08-template" \
  --output "test.html"

# M? file test.html trong browser ?? xem
```

### Test 2: Ki?m tra yêu c?u (user 38)
```bash
curl -X GET "http://localhost:5000/api/SalaryContracts/check-commitment08-required/38" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

**Expected response:**
```json
{
  "message": "Ki?m tra thành công",
  "data": {
    "userId": 38,
    "hasCommitment08": true,
    "isRequired": true,
    "downloadTemplateUrl": "/api/SalaryContracts/download-commitment08-template"
  }
}
```

---

## ?? Frontend Integration (React)

### Component ??n gi?n

```jsx
const Commitment08Download = ({ userId }) => {
  const [requirement, setRequirement] = useState(null);

  useEffect(() => {
    // Check requirement
    fetch(`/api/SalaryContracts/check-commitment08-required/${userId}`, {
      headers: { 'Authorization': `Bearer ${getToken()}` }
    })
      .then(res => res.json())
      .then(data => setRequirement(data.data));
  }, [userId]);

  if (!requirement?.isRequired) {
    return <p>? Không c?n ?i?n Thông t? 08</p>;
  }

  const handleDownload = async () => {
    const response = await fetch('/api/SalaryContracts/download-commitment08-template');
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Mau_Cam_Ket_Thong_Tu_08.html';
    a.click();
  };

  return (
    <div className="alert alert-warning">
      <h4>?? Yêu c?u ?i?n Cam k?t Thông t? 08</h4>
      <p>L??ng c?a b?n: {requirement.baseSalary.toLocaleString()} VN?/tháng</p>
      <button onClick={handleDownload} className="btn btn-primary">
        ?? T?i m?u Cam k?t
      </button>
      <small className="d-block mt-2 text-muted">
        T?i v? ? ?i?n thông tin ? In & ký tên ? Upload l?i cho công ty
      </small>
    </div>
  );
};
```

---

## ?? Quy trình hoàn ch?nh

```
????????????????????????????????????????????????????????
? 1. Admin: T?o Salary Contract                       ?
?    HasCommitment08 = true                            ?
????????????????????????????????????????????????????????
                   ?
                   ?
????????????????????????????????????????????????????????
? 2. Frontend: Check requirement API                   ?
?    ? Hi?n th? thông báo + nút download               ?
????????????????????????????????????????????????????????
                   ?
                   ?
????????????????????????????????????????????????????????
? 3. User: Click nút "T?i m?u Cam k?t"                ?
?    ? File HTML ???c download                         ?
????????????????????????????????????????????????????????
                   ?
                   ?
????????????????????????????????????????????????????????
? 4. User: M? file HTML trong browser                 ?
?    ? ?i?n thông tin cá nhân                          ?
?    ? In ra 2 b?n                                     ?
?    ? Ký tên                                          ?
????????????????????????????????????????????????????????
                   ?
                   ?
????????????????????????????????????????????????????????
? 5. User: Scan/ch?p file ?ã ký                       ?
?    ? L?u thành PDF ho?c JPG                          ?
????????????????????????????????????????????????????????
                   ?
                   ?
????????????????????????????????????????????????????????
? 6. User: Upload file qua frontend                    ?
?    ? PUT /api/SalaryContracts/{id}                   ?
?    ? Attachment = file ?ã ký                         ?
????????????????????????????????????????????????????????
                   ?
                   ?
????????????????????????????????????????????????????????
? 7. Backend: L?u file vào                             ?
?    /uploads/salary-contracts/Nguyen_Van_A_38/        ?
????????????????????????????????????????????????????????
                   ?
                   ?
????????????????????????????????????????????????????????
? 8. Admin: Xem file ?ã n?p                            ?
?    ? GET contract ? attachmentPath có giá tr?        ?
?    ? Click vào link ?? xem/t?i file                  ?
????????????????????????????????????????????????????????
```

---

## ?? L?u ý quan tr?ng

### 1. **?i?u ki?n áp d?ng Thông t? 08**

Ch? dành cho nhân viên:
- ? L??ng ? 2,000,000 VN?/tháng
- ? Không có thu nh?p t? n?i khác
- ? ?ã ký h?p ??ng lao ??ng

### 2. **Trách nhi?m**

- **Admin**: Ki?m tra và set `HasCommitment08 = true` cho ?úng ng??i
- **Nhân viên**: ?i?n ?úng thông tin, ký tên và n?p ?úng h?n
- **Công ty**: L?u gi? b?n g?c và n?p cho c? quan thu? theo quy ??nh

### 3. **File m?u**

- ? File HTML có s?n t?i: `wwwroot/templates/salary-forms/Cam_Ket_Thong_Tu_08.html`
- ?? N?u mu?n thêm file PDF, b?n c?n:
  1. Convert file HTML thành PDF
  2. Upload vào cùng th? m?c
  3. ??t tên: `Cam_Ket_Thong_Tu_08.pdf`

---

## ?? Documentation

- **API chi ti?t**: `COMMITMENT08_TEMPLATE_API_DOCUMENTATION.md`
- **Salary Contracts API**: `SALARY_CONTRACTS_API_DOCUMENTATION.md`

---

## ? Checklist tri?n khai

- [x] T?o th? m?c `wwwroot/templates/salary-forms/`
- [x] T?o file m?u `Cam_Ket_Thong_Tu_08.html`
- [x] Thêm 3 API endpoints vào Controller
- [x] Build thành công
- [ ] Test download HTML template
- [ ] Test check requirement API
- [ ] Tích h?p vào Frontend
- [ ] Test quy trình hoàn ch?nh
- [ ] Deploy lên server

---

## ?? Troubleshooting

### Problem 1: "File m?u không t?n t?i"
**Solution:** Ki?m tra ???ng d?n file:
```bash
ls -la wwwroot/templates/salary-forms/Cam_Ket_Thong_Tu_08.html
```

### Problem 2: Download không ho?t ??ng trong frontend
**Solution:** Ki?m tra CORS và ???ng d?n API:
```javascript
// ??m b?o URL ??y ??
const url = 'http://localhost:5000/api/SalaryContracts/download-commitment08-template';
```

### Problem 3: File HTML không hi?n th? ?úng khi m?
**Solution:** File HTML c?n m? b?ng browser, không ph?i text editor

---

**Created**: 2026-01-06  
**Status**: ? Ready to use  
**Build**: ? Successful
